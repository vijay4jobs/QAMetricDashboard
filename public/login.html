<!doctype html>
<html lang="en" class="h-full">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login - QA Metrics Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#2563EB',
            accent: '#22C55E',
            danger: '#EF4444',
          }
        }
      }
    };
  </script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap');

    * {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .dark .glass {
      background: rgba(17, 24, 39, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .gradient-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    [x-cloak] {
      display: none !important;
    }
  </style>
</head>

<body x-data="loginPage()" x-init="init()"
  class="h-full bg-gradient-to-br from-gray-50 via-blue-50/30 to-indigo-50/50 dark:from-gray-900 dark:via-gray-900 dark:to-gray-800 antialiased">

  <div class="min-h-full flex items-center justify-center px-4 py-12">
    <div class="max-w-md w-full space-y-8">
      <!-- Logo and Header -->
      <div class="text-center">
        <div class="w-20 h-20 mx-auto rounded-2xl gradient-primary flex items-center justify-center shadow-2xl mb-6">
          <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
            </path>
          </svg>
        </div>
        <h2 class="text-4xl font-bold bg-gradient-to-r from-gray-900 to-gray-700 dark:from-white dark:to-gray-300 bg-clip-text text-transparent">
          QA Metrics Dashboard
        </h2>
        <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
          Sign in to access your metrics
        </p>
      </div>

      <!-- Login Form -->
      <div class="glass rounded-2xl shadow-2xl p-8 space-y-6">
        <div x-show="error" x-cloak class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
          <p class="text-sm text-red-800 dark:text-red-200" x-text="error"></p>
        </div>

        <form @submit.prevent="handleLogin()" class="space-y-6">
          <div>
            <label for="project" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Project (required for non-admin users)
            </label>
            <select id="project" x-model="form.projectId" :disabled="isAdminUsername()"
              class="w-full glass border border-gray-200 dark:border-gray-700 rounded-lg px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all disabled:opacity-60 disabled:cursor-not-allowed">
              <option value="">Select Project</option>
              <template x-for="p in projects" :key="p.id">
                <option :value="p.id" x-text="p.name"></option>
              </template>
            </select>
          </div>

          <div>
            <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Username or Email
            </label>
            <input type="text" id="username" x-model="form.username" @input="handleUsernameChange()" required
              class="w-full glass border border-gray-200 dark:border-gray-700 rounded-lg px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
              placeholder="Enter your username">
          </div>

          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Password
            </label>
            <input type="password" id="password" x-model="form.password" required
              class="w-full glass border border-gray-200 dark:border-gray-700 rounded-lg px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
              placeholder="Enter your password">
          </div>

          <button type="submit" :disabled="loading"
            class="w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-medium shadow-lg hover:shadow-xl hover:scale-105 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
            <span x-show="!loading">Sign In</span>
            <span x-show="loading">Signing in...</span>
          </button>
        </form>

        <!-- Auth Options -->
        <div class="flex items-center justify-between text-sm">
          <button @click="showSignup = !showSignup; showForgot = false"
            class="text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 font-medium">
            Create an account
          </button>
          <button @click="showForgot = !showForgot; showSignup = false"
            class="text-gray-600 hover:text-gray-800 dark:text-gray-300 dark:hover:text-white">
            Forgot password?
          </button>
        </div>

        <!-- Signup Panel -->
        <div x-show="showSignup" x-cloak class="border-t border-gray-200 dark:border-gray-700 pt-6 space-y-4">
          <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300">Sign Up</h3>

          <div x-show="signupError" class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3">
            <p class="text-xs text-red-800 dark:text-red-200" x-text="signupError"></p>
          </div>
          <div x-show="signupSuccess" class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-3">
            <p class="text-xs text-green-800 dark:text-green-200" x-text="signupSuccess"></p>
          </div>

          <div class="grid gap-4">
            <input type="text" x-model="signupForm.username" placeholder="Username"
              class="w-full glass border border-gray-200 dark:border-gray-700 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="email" x-model="signupForm.email" placeholder="Email"
              class="w-full glass border border-gray-200 dark:border-gray-700 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="password" x-model="signupForm.password" placeholder="Password"
              class="w-full glass border border-gray-200 dark:border-gray-700 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <select x-model="signupForm.role"
              class="w-full glass border border-gray-200 dark:border-gray-700 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Select Role</option>
              <option value="qa">QA</option>
              <option value="individual">Individual</option>
              <option value="viewer">Viewer</option>
            </select>
          </div>
          <button @click="handleSignup()" :disabled="signupLoading"
            class="w-full px-6 py-2 bg-gradient-to-r from-emerald-600 to-green-600 text-white rounded-lg text-sm font-medium shadow-lg hover:shadow-xl hover:scale-105 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
            <span x-show="!signupLoading">Sign Up</span>
            <span x-show="signupLoading">Creating account...</span>
          </button>
        </div>

        <!-- Forgot Credentials Panel -->
        <div x-show="showForgot" x-cloak class="border-t border-gray-200 dark:border-gray-700 pt-6 space-y-3 text-sm">
          <h3 class="font-semibold text-gray-700 dark:text-gray-300">Forgot your password?</h3>
          <p class="text-gray-600 dark:text-gray-400">
            Please contact your administrator to reset your password or recover your account.
          </p>
          <p class="text-gray-600 dark:text-gray-400">
            If you are an individual user, create a new account using the <span class="font-medium">Sign Up</span> option above.
          </p>
        </div>

        <div class="text-center">
<!--           <p class="text-sm text-gray-600 dark:text-gray-400">
            Default credentials: <strong>admin</strong> / <strong>admin123</strong>
          </p> -->
        </div>
      </div>

    </div>
  </div>

  <script>
    function loginPage() {
      return {
        projects: [],
        form: {
          username: '',
          password: '',
          projectId: ''
        },
        showSignup: false,
        showForgot: false,
        signupForm: { username: '', email: '', password: '', role: '' },
        signupLoading: false,
        signupError: '',
        signupSuccess: '',
        error: '',
        loading: false,

        async init() {
          // Redirect if user info exists (cookie-based auth now)
          try {
            const userStr = localStorage.getItem('user');
            if (userStr) window.location.href = '/index.html';
          } catch {}

          // Load projects for selection
          try {
            const r = await fetch('/api/projects');
            this.projects = await r.json();
          } catch (e) {
            console.warn('Failed to load projects for login:', e);
          }
        },

        isAdminUsername() {
          const u = (this.form.username || '').trim().toLowerCase();
          return u === 'admin' || u === 'admin@qametrics.com';
        },

        handleUsernameChange() {
          if (this.isAdminUsername()) {
            this.form.projectId = '';
          }
        },

        async handleLogin() {
          this.error = '';
          this.loading = true;

          try {
            const response = await fetch('/api/auth/login', {
              method: 'POST',
              credentials: 'include',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                username: this.form.username,
                password: this.form.password,
                projectId: this.form.projectId || null
              })
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.error || 'Login failed');
            }

            // Save token and user info
            localStorage.setItem('authToken', data.token);
            localStorage.setItem('user', JSON.stringify(data.user));
            // Save chosen project for non-admin scoping
            if (this.form.projectId) {
              localStorage.setItem('selectedProjectId', String(this.form.projectId));
              const chosen = this.projects.find(p => String(p.id) === String(this.form.projectId));
              if (chosen) localStorage.setItem('selectedProjectName', chosen.name);
            } else {
              localStorage.removeItem('selectedProjectId');
              localStorage.removeItem('selectedProjectName');
            }

            // Redirect to dashboard
            window.location.href = '/index.html';
          } catch (error) {
            console.error('Login error:', error);
            this.error = error.message || 'Login failed. Please try again.';
          } finally {
            this.loading = false;
          }
        },

        async handleSignup() {
          this.signupError = '';
          this.signupSuccess = '';
          this.signupLoading = true;

          try {
            if (!this.signupForm.username || !this.signupForm.email || !this.signupForm.password || !this.signupForm.role) {
              throw new Error('Please fill all required fields');
            }

            const response = await fetch('/api/auth/register', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.signupForm)
            });

            const data = await response.json().catch(() => ({}));

            if (!response.ok) {
              throw new Error(data.error || 'Failed to create account');
            }

            this.signupSuccess = 'Account created successfully. You can now sign in.';
            this.signupForm = { username: '', email: '', password: '', role: '' };
          } catch (error) {
            console.error('Signup error:', error);
            this.signupError = error.message || 'Failed to create account';
          } finally {
            this.signupLoading = false;
          }
        },

        toggleTheme() {
          document.documentElement.classList.toggle('dark');
        }
      }
    }
  </script>
</body>

</html>

